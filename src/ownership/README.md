# 所有权



## 引用（References）
在 Rust 语言中，确实存在“指针”的概念，但它不像 C/C++ 那样允许你任意操作裸地址，而是通过受控的语义模型来管理指针和内存安全。Rust 中的“引用”（& 和 &mut）其实就是一种“安全的指针”。

```rust
fn main() {
    let x = 10;
    let mut y = 20;
    let r = &x; // 不可变引用
    let m = &mut y; // 可变引用

    println!("r: {}", r); // r: 10
    println!("m: {}", m); // m: 20
    println!("{}", x == 10); // true
    println!("{}", y == 20); // true
}
```

- `&T`：不可变引用，相当于一个只读指针。
- `&mut T`：可变引用，相当于一个独占的可写指针。

引用必须遵循借用规则（borrow rules）：
- 任意时刻只能有一个可变引用，或任意多个不可变引用。
- 引用不能悬空（no dangling pointers）→ 编译器通过生命周期检查确保安全。

**引用本质上就是一种安全指针（safe pointer）。**



Rc<T>：单线程下的共享所有权。
Arc<T>：多线程下的共享所有权（原子引用计数）。
RefCell<T>：运行时可变性，绕过借用检查（只能在单线程）。
Cell<T>：用于 Copy 类型的内部可变性。


在Rust中，所有权（ownership）是一个核心概念，用来管理内存和资源。具有所有权的数据类型是那些负责管理其背后数据的生命周期和内存分配的类型。以下是一些主要的有所有权的数据类型：

### 1. **`String`**

- `String` 是堆分配的字符串类型。它拥有自己的字符串数据，并负责管理内存的分配和释放。当一个 `String`
  的所有权被转移时（比如通过赋值或传递给函数），它的所有权也会随之转移，原所有者不能再使用它。

### 2. **`Vec<T>`（动态数组/向量）**

- `Vec<T>` 是一个动态数组，它可以在堆上动态扩展。`Vec` 类型拥有其存储的所有元素的数据，并负责管理这些元素的内存。当一个
  `Vec` 的所有权被转移时，存储的所有元素的所有权也被转移。

### 3. **`Box<T>`**

- `Box<T>` 是一种智能指针，用来将数据分配到堆上。`Box` 拥有指向的数据，并负责释放它所指向的内存。当 `Box`
  的所有权被转移时，它指向的数据的所有权也会被转移。

### 4. **`HashMap<K, V>` 和 `BTreeMap<K, V>`**

- 这两种类型分别是基于哈希表和二叉树的键值对存储结构，它们拥有所有存储的键和值。与 `Vec` 类似，它们管理存储在内部的数据的生命周期。

### 5. **`Struct`（结构体）**

- 结构体本身可以包含其他类型的数据，并且结构体本身拥有其字段的数据。如果结构体的字段类型是有所有权的，那么结构体也会对这些字段拥有所有权。

### 6. **`Tuple`（元组）**

- 与结构体类似，元组也是可以包含多个不同类型的数据的复合类型。如果元组的元素是有所有权的数据类型，那么元组也拥有这些元素的数据。

### 7. **`Enum`（枚举）**

- 枚举类型可以存储多种不同类型的数据，并且如果某个枚举变体持有有所有权的数据类型，那么该枚举也会拥有这些数据。

### 8. **`Rc<T>` 和 `Arc<T>`**

- `Rc<T>` 是单线程的引用计数智能指针，`Arc<T>`
  是线程安全的引用计数智能指针。这些类型通过引用计数来共享数据的所有权，数据的生命周期由引用计数管理。尽管它们通过多个指针共享所有权，但仍然对数据拥有所有权。

### 9. **`PathBuf`**

- `PathBuf` 是堆分配的路径类型，它与 `String` 类似，拥有路径字符串的所有权。

### 10. **`OsString`**

- `OsString` 是一种可以表示操作系统字符串的类型，它拥有其底层数据的所有权，与 `String` 类似。

### 其他类型和扩展

- **`Cow<T>`**: 这种类型可以在拥有数据和借用数据之间动态切换。如果它拥有数据（`Cow::Owned`），那么它也会管理这些数据的生命周期。
- **`Option<T>` 和 `Result<T, E>`**: 如果 `Option` 或 `Result` 类型包含的值是有所有权的，那么它们也会拥有这些值的所有权。

### 总结

具有所有权的数据类型一般是那些在堆上分配数据或管理资源的类型。Rust
通过所有权系统来确保内存安全，所有有所有权的数据类型都负责管理其数据的生命周期，并且在它们的作用域结束时自动释放资源。

| 借用类型          | 是否可修改 | 是否可同时存在多个 | 示例说明        |
|---------------|-------|-----------|-------------|
| 不可变借用 `&T`    | 否     | ✅ 可以多个    | 安全共享读       |
| 可变借用 `&mut T` | ✅ 是   | ❌ 只能一个    | 独占写         |
| 可变 & 不可变混用    | ❌ 禁止  | ❌ 编译错误    | 防止数据竞争和悬垂引用 |
